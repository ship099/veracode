name: 'Organization workflow action'
on:
  workflow_call:
    outputs:
      run_id:
        description: "The first output string"
        value: ${{ jobs.create_check_run.outputs.run_id }}
    inputs:
      run_id: 
        description: 'ID of workflow run (provided via GitHub syntax `github.run_id`)'
        required: true
        type: string
      repositroy_owner: 
        description: 'repositroy_owner of original commit (provided by GitHub app via `github.event.client_payload.repository.owner`)'
        required: true
        type: string
      repositroy_name: 
        description: 'repositroy_name of original commit (provided by GitHub app via `github.event.client_payload.repository.name`)'
        required: true
        type: string
      check_run_name: 
        description: 'Name of check (Use `github.workflow` to use the name of the workflow)'
        required: true
        type: string
      head_sha: 
        description: 'head_sha of original commit (provided by GitHub app via `github.event.client_payload.sha`)'
        required: true
        type: string
      github_token: 
        description: 'github_token is a token (provided by GitHub app via `github.event.client_payload.token`)'
        required: true
        type: string
      event_type:
        description: 'event_type triggered by the GitHub App (provided by GitHub app via `github.event.client_payload.event_type`)'
        required: true
        type: string
      branch:
        description: 'branch triggered by the GitHub App (provided by GitHub app via `github.event.client_payload.repository.branch`)'
        required: true
        type: string
      default_runs_on:
        required: true
        type: string

jobs:
  create_check_run:
    runs-on: ${{ fromJson(inputs.default_runs_on) }}
    outputs:
      run_id: ${{ steps.create_check.outputs.run_id }}

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Create check run via GitHub API
        id: create_check
        uses: actions/github-script@v7
        with:
          github-token: ${{ inputs.github_token }}
          script: |
            const owner = '${{ inputs.repositroy_owner }}'
            const repo = '${{ inputs.repositroy_name }}'
            const name = '${{ inputs.check_run_name }}'
            const head_sha = '${{ inputs.head_sha }}'
            const details_url = `https://github.com/${{ github.repository }}/actions/runs/${{ inputs.run_id }}`

            const response = await github.rest.checks.create({
              owner,
              repo,
              name,
              head_sha,
              status: 'in_progress',
              details_url
            })

            const checkRunId = response.data.id
            core.setOutput('run_id', checkRunId)

            // Create workflow-metadata.json
            const fs = require('fs')

            const metadata = {
              check_run_type: '${{ inputs.event_type }}',
              repository_name: repo,
              check_run_id: checkRunId,
              branch: '${{ inputs.branch }}',
              sha: head_sha
            }

            fs.writeFileSync(
              'workflow-metadata.json',
              JSON.stringify(metadata, null, 2)
            )

            core.info(`Created check run ${checkRunId}`)

      - name: Save metadata
        uses: actions/upload-artifact@v4
        with:
          name: workflow-metadata
          path: workflow-metadata.json
